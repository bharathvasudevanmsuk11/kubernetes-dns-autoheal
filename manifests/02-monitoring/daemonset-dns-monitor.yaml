apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: dns-throttle-monitor
  namespace: monitoring
  labels:
    app: dns-throttle-monitor
    version: v1.0.0
spec:
  selector:
    matchLabels:
      app: dns-throttle-monitor
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: dns-throttle-monitor
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: dns-monitor
      hostNetwork: true
      hostPID: true
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
      containers:
      - name: monitor
        image: amazon/aws-cli:2.13.0
        command: ["/bin/bash", "-c"]
        args:
          - |
            # Install dependencies
            yum install -y wget tar gzip procps-ng || true
            
            # Download and install node_exporter
            cd /tmp
            wget -q https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
            tar xzf node_exporter-1.7.0.linux-amd64.tar.gz
            
            # Create textfile directory
            mkdir -p /var/lib/node_exporter/textfile_collector
            
            # Start node_exporter in background
            /tmp/node_exporter-1.7.0.linux-amd64/node_exporter \
              --web.listen-address=":9100" \
              --collector.textfile.directory=/var/lib/node_exporter/textfile_collector &
            
            echo "Node exporter started on port 9100"
            
            # Run monitoring script every 60 seconds
            while true; do
              echo "Running DNS monitoring script..."
              /scripts/monitor.sh || echo "Monitor script failed, retrying..."
              sleep 60
            done
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        volumeMounts:
        - name: scripts
          mountPath: /scripts
          readOnly: true
        - name: metrics
          mountPath: /var/lib/node_exporter/textfile_collector
        env:
        - name: AWS_DEFAULT_REGION
          value: "us-east-1"
        - name: AZURE_RESOURCE_ID
          value: ""
      volumes:
      - name: scripts
        configMap:
          name: dns-monitor-script
          defaultMode: 0755
      - name: metrics
        emptyDir: {}
